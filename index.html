<!DOCTYPE html>
<html lang="en">
<head>
  <title>The Standard</title>
  <meta name="viewport" content="width=device-width, user-scalable=no" />
  <script src="shared.js"></script>
  <script src="elements/device.js"></script>
  <script src="elements/scene.js"></script>
  <script src="elements/page.js"></script>
  <script src="elements/lines.js"></script>
  <style type="text/css">

html {
  background: #eaeaea;
  min-height: 100vh;
  font-family: 'Roboto', Sans-Serif;
}
body {
  margin: 0;
}

header {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  background: #ccc;
  padding: 8px;
}

ts-scene[disabled] {
  opacity: 0.25;
}

</style>
</head>
<body>

<header>
  <button id="type">Device</button>
  <button id="toggle">Toggle</button>
  <select id="videos">
    <option value="">▶︎ Choose</option>
  </select>
</header>

<ts-scene id="scene" disabled>
  <ts-device device="tablet">
    <ts-page>
    </ts-page>
  </ts-device>
</ts-scene>

<script>

const sceneInterval = 1000;
let scripts;

window.fetch('scripts.json').then(out => out.json()).then(out => {
  scripts = out;  // save global
  const keys = Object.keys(out).sort();
  for (const id of keys) {
    const option = document.createElement('option');
    option.value = id;
    option.text = out[id].name;
    videos.add(option);
  }

  if (window.location.hash) {
    window.dispatchEvent(new CustomEvent('hashchange'));
  }
});

window.addEventListener('hashchange', function() {
  console.info('hashchange', window.location.hash);
  const part = window.location.hash.substr(1);
  if (part in scripts) {
    select.value = part;
  } else {
    select.value = '';
  }
  playVideo(part);
});

const select = document.querySelector('select#videos');
select.addEventListener('change', ev => {
  if (select.value) {
    window.location.hash = `#${select.value}`;
  } else {
    window.history.pushState(null, null, '/');
    playVideo('');
  }
});

const playVideo = (function() {
  const scene = document.querySelector('ts-scene');
  const device = scene.querySelector('ts-device');
  const page = device.querySelector('ts-page');

  function reset() {
    page.class = '';
    scene.scene = null;
    device.overflow = false;
  }

  let interval;
  return function(id) {
    console.info('got id', id);
    window.clearInterval(interval);

    if (!id) {
      page.html = '';
      page.css = '';
      return reset();
    }

    const s = scripts[id];
    if (!s) {
      throw new Error('no script for: ' + id);
    }

    const result = {};

    const fetchHTML = window.fetch(`scripts/${id}.html`)
        .then(out => out.text())
        .then(v => { result.html = v; });

    const fetchCSS = window.fetch(`scripts/${id}.css`)
        .then(out => out.text())
        .then(v => { result.css = v; });

    Promise.all([fetchHTML, fetchCSS]).then(_ => {
      page.html = result.html;
      page.css = result.css;
    }).then(_ => {
      let i = -1;
      interval = window.setInterval(function() {
        switch (i) {
        case -1:
          console.info(id, 'start frame');
          i = 0;
          reset();
          scene.removeAttribute('disabled');
          return;
        case s.frames.length:
          console.info(id, 'last frame');
          i = -1;
          scene.setAttribute('disabled', '');
          return;
        }

        console.info(id, 'frame', i);
        const frame = s.frames[i];
        if (frame.class) { page.class = frame.class; }
        if ('scene' in frame) { scene.scene = frame.scene; }
        if ('overflow' in frame) { device.overflow = frame.overflow; }
        ++i;
      }, sceneInterval);
    });
  };
}());

const device = document.querySelector('ts-device');
document.querySelector('button#type').addEventListener('click', ev => device.stepDevice());

</script>

</body>
</html>