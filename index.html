<!DOCTYPE html>
<html lang="en">
<head>
  <title>The Standard</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css?family=Lobster" rel="stylesheet" />
  <meta name="viewport" content="width=device-width, user-scalable=no" />
  <script src="shared.js"></script>
  <script src="elements/device.js"></script>
  <script src="elements/scene.js"></script>
  <script src="elements/page.js"></script>
  <script src="elements/lines.js"></script>
  <style type="text/css">

html {
  background: #eaeaea;
  min-height: 100vh;
  font-family: 'Roboto', Sans-Serif;
  overflow-x: hidden;
}
body {
  margin: 0;
}

header {
  z-index: 1000;
  position: absolute;
  top: 100vh;
  left: 0;
  width: 100%;
  background: #ccc;
  padding: 8px;
}

ts-scene[disabled] {
  opacity: 0.25;
}

</style>
</head>
<body>

<header>
  <button id="type">Device</button>
  <select id="videos">
    <option value="">▶︎ Choose</option>
  </select>
</header>

<ts-scene id="scene" disabled>
  <ts-device device="tablet">
    <ts-page>
    </ts-page>
  </ts-device>
</ts-scene>

<script>

const device = document.querySelector('ts-device');
const sceneInterval = 2500;
let scripts;

window.fetch('scripts.json').then(out => out.json()).then(out => {
  scripts = out;  // save global
  const keys = Object.keys(out).sort();
  for (const id of keys) {
    const option = document.createElement('option');
    option.value = id;
    option.text = out[id].name;
    videos.add(option);
  }

  if (window.location.hash) {
    window.dispatchEvent(new CustomEvent('hashchange'));
  }
});

window.addEventListener('hashchange', function() {
  console.info('hashchange', window.location.hash);
  const part = window.location.hash.substr(1);
  if (part in scripts) {
    select.value = part;
  } else {
    select.value = '';
  }
  playVideo(part);
});

const select = document.querySelector('select#videos');
select.addEventListener('change', ev => {
  if (select.value) {
    window.location.hash = `#${select.value}`;
  } else {
    window.history.pushState(null, null, '/');
    playVideo('');
  }
});

const playVideo = (function() {
  const scene = document.querySelector('ts-scene');
  const device = scene.querySelector('ts-device');
  const page = device.querySelector('ts-page');

  function reset() {
    page.class = '';
    scene.scene = null;
    device.overflow = false;
  }

  let interval;
  return function(id) {
    console.info('got id', id);
    window.clearTimeout(interval);

    if (!id) {
      page.html = '';
      page.css = '';
      return reset();
    }

    const s = scripts[id];
    if (!s) {
      throw new Error('no script for: ' + id);
    }

    const result = {};

    const fetchHTML = window.fetch(`scripts/${id}.html`)
        .then(out => out.text())
        .then(v => { result.html = v; });

    const fetchCSS = window.fetch(`scripts/${id}.css`)
        .then(out => out.text())
        .then(v => { result.css = v; });

    Promise.all([fetchHTML, fetchCSS]).then(_ => {
      page.html = result.html;
      page.css = result.css;
    }).then(_ => {
      let i = -1;
      interval = window.setTimeout(function draw() {
        let nextDelay = sceneInterval;

        switch (i) {
        case -1:
          console.info(id, 'start frame');
          i = 0;
          reset();
          scene.removeAttribute('disabled');
          break;
        case s.frames.length:
          console.info(id, 'last frame');
          i = -1;
          scene.setAttribute('disabled', '');
          break;
        default:
          console.info(id, 'frame', i);
          const frame = s.frames[i];
          if ('class' in frame) { page.class = frame.class; }
          if ('scene' in frame) { scene.scene = frame.scene; }
          if ('overflow' in frame) { device.overflow = frame.overflow; }
          if ('delay' in frame) { nextDelay = Math.max(frame.delay, nextDelay); }

          if ('keyboard' in frame) {
            const k = frame.keyboard;
            const el = page.q(k.q);
            let remaining = k.value || '';
            el.focus();
            let first = true;

            const seg = (nextDelay / remaining.length) * 0.75;
            const interval = window.setInterval(() => {
              if (first) {
                el.value = '';
                first = false;
                return;
              }
              if (!remaining.length) {
                window.clearInterval(interval);
                return;
              }
              let i = 0;
              while (remaining[i] === ' ') {
                ++i;
              }
              el.value = el.value + remaining.substr(0, i + 1);
              el.focus();
              remaining = remaining.substr(i + 1);
            }, seg);
          }

          if ('click' in frame) {
            const el = page.q(frame.click);
            el.focus();
            window.setTimeout(() => {
              el.click();
            }, nextDelay * 0.25);
            window.setTimeout(() => {
              (document.activeElement || el).blur();
            }, nextDelay * 0.75);

          }

          ++i;
          break;
        }

        interval = window.setTimeout(draw, nextDelay);
      }, sceneInterval);
    });
  };
}());

document.querySelector('button#type').addEventListener('click', ev => device.stepDevice());

</script>

</body>
</html>